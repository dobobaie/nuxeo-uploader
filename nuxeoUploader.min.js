var fs=require("fs"),btoa=require("btoa"),filename=require("file-name"),mime=require("mime-types"),request=require("request"),babyWorkers=require("baby-workers"),dataFactory=require("data-factory"),nuxeoUploader=function(e,t){var n={this:this,url:e,token:"string"==typeof t?t:"string"==typeof t.token?t.token:"Basic "+btoa(t.auth.user+":"+t.auth.pwd)};return(new function(){this.run=function(t){return new Promise(function(n,i){var u=new babyWorkers;u.create("initAttach",function(n){e(n,t.attach)}).run(),u.create("initFile",function(n){e(n,t.file)}).run(),u.then(function(e){return d.resolve=n,d.reject=i,d.id_parent=t.id_parent,d.id_file=t.id_file,d.infosFile=null==(tmp=u.initFile.get())?{}:tmp,d.infosAttach=null==(tmp=u.initAttach.get())?[]:tmp,d.document="object"==typeof t.document?t.document:{},d.document.name=void 0==d.document.name?d.infosFile.name:d.document.name,d.document.title=void 0==d.document.title?d.document.name:d.document.title,d.document.description=void 0==d.document.description?"":d.document.description,null!=d.id_file&&d.id_file,o()},!1)}).catch(reject)};var e=function(e,n){if(void 0==n)return e.pop();var i=[],o=1==Array.isArray(n)?n:[n];for(var u in o){var r=void 0==o[u].url?o[u]:o[u].url,l=filename(r)+"."+(tmp=r.split("."))[tmp.length-1],a=fs.statSync(r);i.push({id:void 0==o[u].id?null:o[u].id,file:o[u],url:r,name:l,size:a.size,type:mime.lookup(l)})}e.create("uploadFiles",t,i).save(new dataFactory).run(),e.uploadFiles.then(function(){var t=1==Array.isArray(n)?e.uploadFiles.get().getStack():e.uploadFiles.get().getStack()[0];e._save(t),e.pop()}).catch(e.pop)},t=function(e,t){request.post(a("upload"),function(n,o,u){if(null!=n||500==o.statusCode||404==o.statusCode)return e.error("Error uploadGenerateBatchId function "+JSON.stringify(null==n||void 0==n?u:n)),e.pop();t.batchId=u.batchId,i(e,t)})},i=function(e,t){var n=null==t.id?e.getId():t.id;fs.createReadStream(t.url).pipe(request.post(a("upload/"+t.batchId+"/"+n,null,{"Content-Type":"application/octet-stream","Content-Length":t.size,"X-File-Type":t.type,"X-File-Name":t.name}),function(i,o,u){if(null!=i||500==o.statusCode||404==o.statusCode)return e.error('Error uploadFile function file = "'+d.document.name+'" '+JSON.stringify(null==i||void 0==i?u:i)),e.pop();t.id=n,t.batchId=u.batchId,e._get().push(t),e.pop()}))},o=function(){if(null==d.id_file)return u();request.get(a("id/"+d.id_file),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return u();d.infosDocument=n,r()})},u=function(){request.post(a("id/"+d.id_parent,{name:d.document.name,"entity-type":"document",type:"File",properties:{"dc:title":d.document.title,"dc:description":d.document.description,"common:icon":null,"common:icon-expanded":null,"common:size":null}}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return d.reject('Error uploadCreateDocument function file = "'+d.document.name+'" '+JSON.stringify(null==e||void 0==e?n:e));d.infosDocument=n,r()})},r=function(){request.put(a("id/"+d.infosDocument.uid,{name:d.document.name,"entity-type":"document",type:"File",properties:l()}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return d.reject('Error uploadUpdateDocument function file = "'+d.document.name+'" '+JSON.stringify(null==e||void 0==e?n:e));d.resolve(n)})},l=function(){var e={};if(void 0!=d.infosFile.batchId&&(e["file:content"]={"upload-batch":d.infosFile.batchId,"upload-fileId":d.infosFile.id}),0!=d.infosAttach.length){e["files:files"]=[];for(var t in d.infosAttach)e["files:files"].push({file:{"upload-batch":d.infosAttach[t].batchId,"upload-fileId":d.infosAttach[t].id}})}return e},a=function(e,t,i){var o={url:n.url+e,headers:{Authorization:n.token,"Content-Type":"application/json"},json:!0};null!==t&&void 0!==t&&(o.body=t);for(var u in i)o.headers[u]=i[u];return o},d={this:this,resolve:null,reject:null,id_parent:null,id_file:null,document:null,infosDocument:null,infosFile:{},infosAttach:[]};return d.this}).run};module.exports=nuxeoUploader;