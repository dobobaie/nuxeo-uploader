var fs=require("fs"),btoa=require("btoa"),filename=require("file-name"),mime=require("mime-types"),request=require("request"),babyWorkers=require("baby-workers"),nuxeoUploader=function(e,t){var n={this:this,url:e,token:"string"==typeof t?t:"string"==typeof t.token?t.token:"Basic "+btoa(t.auth.user+":"+t.auth.pwd)};return(new function(){this.run=function(t){return new Promise(function(n,i){var o=new babyWorkers;o.create("initAttach",function(n){e(n,t.attach)}).run(),o.create("initFile",function(n){e(n,t.file)}).run(),o.then(function(e){return c.resolve=n,c.reject=i,c.id_parent=t.id_parent,c.id_file=t.id_file,c.infosFile=null==(tmp=o.initFile.get())?{}:tmp,c.infosAttach=null==(tmp=o.initAttach.get())?[]:tmp,c.document="object"==typeof t.document?t.document:{},c.document.name=null==c.document.name?c.infosFile.name:c.document.name,c.document.title=null==c.document.title?c.document.name:c.document.title,c.document.description=null==c.document.description?"":c.document.description,null!=c.id_file&&c.id_file,u()},!1)}).catch(reject)};var e=function(e,n){if(null==n)return e.pop();var i=[],u=1==Array.isArray(n)?n:[n];for(var o in u){var l=null==u[o].url?u[o]:u[o].url,r=filename(l)+"."+(tmp=l.split("."))[tmp.length-1],a=fs.statSync(l);i.push({id:null==u[o].id?null:u[o].id,file:u[o],url:l,name:r,size:a.size,type:mime.lookup(r)})}e.create("uploadFiles",t,i).save([]).run(),e.uploadFiles.then(function(){var t=1==Array.isArray(n)?e.uploadFiles.get():e.uploadFiles.get()[0];e._save(t),e.pop()}).catch(e.pop)},t=function(e,t){request.post(a("upload"),function(n,u,o){if(null!=n||500==u.statusCode||404==u.statusCode)return e.error("Error uploadGenerateBatchId function "+JSON.stringify(null==n||null==n?o:n)),e.pop();t.batchId=o.batchId,i(e,t)})},i=function(e,t){var n=null==t.id?e.getId():t.id;fs.createReadStream(t.url).pipe(request.post(a("upload/"+t.batchId+"/"+n,null,{"Content-Type":"application/octet-stream","Content-Length":t.size,"X-File-Type":t.type,"X-File-Name":t.name}),function(i,u,o){if(null!=i||500==u.statusCode||404==u.statusCode)return e.error('Error uploadFile function file = "'+c.document.name+'" '+JSON.stringify(null==i||null==i?o:i)),e.pop();t.id=n,t.batchId=o.batchId,e._get().push(t),e.pop()}))},u=function(){if(null==c.id_file)return o();request.get(a("id/"+c.id_file),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return o();c.infosDocument=n,l()})},o=function(){request.post(a("id/"+c.id_parent,{name:c.document.name,"entity-type":"document",type:"File",properties:{"dc:title":c.document.title,"dc:description":c.document.description,"common:icon":null,"common:icon-expanded":null,"common:size":null}}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return c.reject('Error uploadCreateDocument function file = "'+c.document.name+'" '+JSON.stringify(null==e||null==e?n:e));c.infosDocument=n,l()})},l=function(){request.put(a("id/"+c.infosDocument.uid,{name:c.document.name,"entity-type":"document",type:"File",properties:r()}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return c.reject('Error uploadUpdateDocument function file = "'+c.document.name+'" '+JSON.stringify(null==e||null==e?n:e));c.resolve(n)})},r=function(){var e={};if(null!=c.infosFile.batchId&&(e["file:content"]={"upload-batch":c.infosFile.batchId,"upload-fileId":c.infosFile.id}),0!=c.infosAttach.length)for(var t in e["files:files"]=[],c.infosAttach)e["files:files"].push({file:{"upload-batch":c.infosAttach[t].batchId,"upload-fileId":c.infosAttach[t].id}});return e},a=function(e,t,i){var u={url:n.url+e,headers:{Authorization:n.token,"Content-Type":"application/json"},json:!0};for(var o in null!=t&&(u.body=t),i)u.headers[o]=i[o];return u},c={this:this,resolve:null,reject:null,id_parent:null,id_file:null,document:null,infosDocument:null,infosFile:{},infosAttach:[]};return c.this}).run};module.exports=nuxeoUploader;