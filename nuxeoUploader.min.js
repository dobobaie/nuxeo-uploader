var fs=require("fs"),btoa=require("btoa"),filename=require("file-name"),mime=require("mime-types"),request=require("request"),babyWorkers=require("baby-workers"),dataFactory=require("data-factory"),nuxeoUploader=function(e,t){var n={this:this,url:e,token:"string"==typeof t?t:"string"==typeof t.token?t.token:"Basic "+btoa(t.auth.user+":"+t.auth.pwd)};return(new function(){this.run=function(t){return new Promise(function(n,i){var r=new babyWorkers;r.create("initAttach",function(n){e(n,t.attach)}).run(),r.create("initFile",function(n){e(n,t.file)}).run(),r.complete(function(e){return null!=e?i(e):(d.resolve=n,d.reject=i,d.id_parent=t.id_parent,d.id_file=t.id_file,d.infosFile=null==(tmp=r.initFile.get())?{}:tmp,d.infosAttach=null==(tmp=r.initAttach.get())?[]:tmp,d.document="object"==typeof t.document?t.document:{},d.document.name=void 0==d.document.name?d.infosFile.name:d.document.name,d.document.title=void 0==d.document.title?"":d.document.title,d.document.description=void 0==d.document.description?"":d.document.description,null!=d.id_file&&d.id_file,o())},!1)})};var e=function(e,n){if(void 0==n)return e.pop();var i=[],o=1==Array.isArray(n)?n:[n];for(var r in o){var u=void 0==o[r].url?o[r]:o[r].url,l=filename(u)+"."+(tmp=u.split("."))[tmp.length-1],a=fs.statSync(u);i.push({id:void 0==o[r].id?null:o[r].id,file:o[r],url:u,name:l,size:a.size,type:mime.lookup(l)})}e.create("uploadFiles",t,i).save(new dataFactory).run(),e.uploadFiles.complete(function(t,i){if(null!==t)return e.error(t,i),e.pop();var o=1==Array.isArray(n)?e.uploadFiles.get().getStack():e.uploadFiles.get().getStack()[0];e._save(o),e.pop()})},t=function(e,t){request.post(a("upload"),function(n,o,r){if(null!=n||500==o.statusCode||404==o.statusCode)return e.error("Error uploadGenerateBatchId function "+JSON.stringify(null==n||void 0==n?r:n)),e.pop();t.batchId=r.batchId,i(e,t)})},i=function(e,t){var n=null==t.id?e.getId():t.id;fs.createReadStream(t.url).pipe(request.post(a("upload/"+t.batchId+"/"+n,null,{"Content-Type":"application/octet-stream","Content-Length":t.size,"X-File-Type":t.type,"X-File-Name":t.name}),function(i,o,r){if(null!=i||500==o.statusCode||404==o.statusCode)return e.error('Error uploadFile function file = "'+d.document.name+'" '+JSON.stringify(null==i||void 0==i?r:i)),e.pop();t.id=n,t.batchId=r.batchId,e._get().push(t),e.pop()}))},o=function(){request.get(a("id/"+d.id_file),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return r();d.infosDocument=n,u()})},r=function(){request.post(a("id/"+d.id_parent,{name:d.document.name,"entity-type":"document",type:"File",properties:{"dc:title":d.document.title,"dc:description":d.document.description}}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return d.reject('Error uploadCreateDocument function file = "'+d.document.name+'" '+JSON.stringify(null==e||void 0==e?n:e));d.infosDocument=n,u()})},u=function(){request.put(a("id/"+d.infosDocument.uid,{name:d.document.name,"entity-type":"document",type:"File",properties:l()}),function(e,t,n){if(null!=e||500==t.statusCode||404==t.statusCode)return d.reject('Error uploadUpdateDocument function file = "'+d.document.name+'" '+JSON.stringify(null==e||void 0==e?n:e));d.resolve(n)})},l=function(){var e={};if(void 0!=d.infosFile.batchId&&(e["file:content"]={"upload-batch":d.infosFile.batchId,"upload-fileId":d.infosFile.id}),0!=d.infosAttach.length){e["files:files"]=[];for(var t in d.infosAttach)e["files:files"].push({file:{"upload-batch":d.infosAttach[t].batchId,"upload-fileId":d.infosAttach[t].id}})}return e},a=function(e,t,i){var o={url:n.url+e,headers:{Authorization:n.token,"Content-Type":"application/json"},json:!0};null!==t&&void 0!==t&&(o.body=t);for(var r in i)o.headers[r]=i[r];return o},d={this:this,resolve:null,reject:null,id_parent:null,id_file:null,document:null,infosDocument:null,infosFile:{},infosAttach:[]};return d.this}).run};module.exports=nuxeoUploader;